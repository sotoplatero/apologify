---
import Layout from '../../layouts/Layout.astro';
import { getLettersPaginated, getRecipientCounts, getToneCounts } from '../../lib/db';
import { tones as officialTones } from '../../lib/apologyData.js';
import LetterDirectory from '../../components/LetterDirectory.svelte';

export const prerender = false;

const PAGE_SIZE = 24;

// Read query params
const url = new URL(Astro.request.url);
const currentPage = Math.max(1, parseInt(url.searchParams.get('page') || '1'));
const recipientFilter = url.searchParams.get('recipient') || undefined;
const toneFilter = url.searchParams.get('tone') || undefined;
const searchTerm = url.searchParams.get('q') || undefined;

// Fetch paginated letters with filters
const { letters, total, lastPage } = await getLettersPaginated(currentPage, PAGE_SIZE, {
  recipient: recipientFilter,
  tone: toneFilter,
  searchTerm,
});

// Get counts for stats
const [recipientCounts, rawToneCounts] = await Promise.all([
  getRecipientCounts(),
  getToneCounts(),
]);

// Only show official tones in the filter
const officialToneValues = new Set(officialTones.map(t => t.value));
const toneCounts: Record<string, number> = {};
for (const [tone, count] of Object.entries(rawToneCounts)) {
  if (officialToneValues.has(tone)) {
    toneCounts[tone] = count;
  }
}

const recipientCount = Object.keys(recipientCounts).length;
const toneCount = Object.keys(toneCounts).length;

// Prepare letters for client
const lettersForClient = letters.map(letter => ({
  slug: letter.slug,
  recipient: letter.recipient,
  context: letter.context,
  tone: letter.tone,
  title: letter.title || letter.context,
  letters: [letter.letters[0]?.slice(0, 200) || ''],
  source: letter.source || 'static',
  created_at: letter.created_at,
}));

// Build pagination URL helper
function buildPageUrl(page: number): string {
  const params = new URLSearchParams();
  if (page > 1) params.set('page', String(page));
  if (recipientFilter) params.set('recipient', recipientFilter);
  if (toneFilter) params.set('tone', toneFilter);
  if (searchTerm) params.set('q', searchTerm);
  const qs = params.toString();
  return `/examples${qs ? '?' + qs : ''}`;
}

// Generate page numbers to display
function getPageNumbers(current: number, last: number): (number | '...')[] {
  if (last <= 7) return Array.from({ length: last }, (_, i) => i + 1);

  const pages: (number | '...')[] = [];
  if (current <= 4) {
    pages.push(1, 2, 3, 4, 5, '...', last);
  } else if (current >= last - 3) {
    pages.push(1, '...', last - 4, last - 3, last - 2, last - 1, last);
  } else {
    pages.push(1, '...', current - 1, current, current + 1, '...', last);
  }
  return pages;
}

const pageNumbers = getPageNumbers(currentPage, lastPage);

// Active filter info
const hasFilters = recipientFilter || toneFilter || searchTerm;
---

<Layout title="Apology Letter Examples" description="Browse our collection of apology letter examples for every situation">
  <main class="container mx-auto px-4 sm:px-6 py-8 sm:py-12">
    <!-- Header Section -->
    <div class="text-center space-y-3 sm:space-y-4 mb-10 sm:mb-16">
      <h1 class="text-3xl sm:text-4xl md:text-6xl font-bold text-gray-800 leading-tight tracking-tight">
        Apology Letter Examples
      </h1>
      <p class="text-lg sm:text-xl text-gray-600 max-w-2xl mx-auto">
        Browse our collection of {total.toLocaleString()} apology letters for every situation
      </p>
    </div>

    <!-- Filter Bar -->
    <div class="mb-8">
      <form method="get" action="/examples" class="grid grid-cols-2 sm:flex sm:items-end gap-3 sm:gap-4 w-full">
        <!-- Recipient Filter -->
        <div>
          <label class="label font-sans text-sm"><span class="label-text">Recipient</span></label>
          <select name="recipient" class="select select-bordered font-sans w-full">
            <option value="">All Recipients</option>
            {Object.entries(recipientCounts).sort((a, b) => a[0].localeCompare(b[0])).map(([value, count]) => (
              <option value={value} selected={recipientFilter === value}>
                {value.charAt(0).toUpperCase() + value.slice(1)} ({count})
              </option>
            ))}
          </select>
        </div>

        <!-- Tone Filter -->
        <div>
          <label class="label font-sans text-sm"><span class="label-text">Tone</span></label>
          <select name="tone" class="select select-bordered font-sans w-full">
            <option value="">All Tones</option>
            {Object.entries(toneCounts).sort((a, b) => b[1] - a[1]).map(([value, count]) => (
              <option value={value} selected={toneFilter === value}>
                {value.charAt(0).toUpperCase() + value.slice(1)} ({count})
              </option>
            ))}
          </select>
        </div>

        <!-- Search -->
        <div class="col-span-2 sm:col-span-1">
          <label class="label font-sans text-sm"><span class="label-text">Search</span></label>
          <input
            type="text"
            name="q"
            value={searchTerm || ''}
            placeholder="Search letters..."
            class="input input-bordered font-sans w-full sm:w-48"
          />
        </div>

        <div class="col-span-2 sm:col-span-1 flex gap-2 sm:gap-4">
          <button type="submit" class="btn btn-primary font-sans flex-1 sm:flex-none">Filter</button>
          {hasFilters && (
            <a href="/examples" class="btn btn-ghost font-sans flex-1 sm:flex-none">Clear</a>
          )}
        </div>
      </form>
    </div>

    <!-- Letter Grid -->
    <LetterDirectory client:load initialLetters={lettersForClient} />

    <!-- Pagination Controls -->
    {lastPage > 1 && (
      <div class="flex justify-center mt-12">
        <div class="join font-sans">
          {/* Previous */}
          {currentPage > 1 ? (
            <a href={buildPageUrl(currentPage - 1)} class="join-item btn btn-sm">
              <svg class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" />
              </svg>
              Prev
            </a>
          ) : (
            <button class="join-item btn btn-sm btn-disabled" disabled>
              <svg class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" />
              </svg>
              Prev
            </button>
          )}

          {/* Page Numbers */}
          {pageNumbers.map((p) => (
            p === '...' ? (
              <button class="join-item btn btn-sm btn-disabled" disabled>...</button>
            ) : p === currentPage ? (
              <button class="join-item btn btn-sm btn-primary">{p}</button>
            ) : (
              <a href={buildPageUrl(p)} class="join-item btn btn-sm">{p}</a>
            )
          ))}

          {/* Next */}
          {currentPage < lastPage ? (
            <a href={buildPageUrl(currentPage + 1)} class="join-item btn btn-sm">
              Next
              <svg class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" />
              </svg>
            </a>
          ) : (
            <button class="join-item btn btn-sm btn-disabled" disabled>
              Next
              <svg class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" />
              </svg>
            </button>
          )}
        </div>
      </div>

      <div class="text-center mt-4 text-sm text-gray-500 font-sans">
        Showing {((currentPage - 1) * PAGE_SIZE) + 1}â€“{Math.min(currentPage * PAGE_SIZE, total)} of {total.toLocaleString()} letters
        {hasFilters && <span> (filtered)</span>}
      </div>
    )}

    <!-- CTA Section -->
    <div class="mt-12 sm:mt-16 text-center">
      <div class="bg-gradient-to-r from-purple-500 to-blue-500 rounded-2xl p-6 sm:p-8 text-white">
        <h2 class="text-xl sm:text-2xl font-bold mb-3 sm:mb-4">Need a Custom Apology Letter?</h2>
        <p class="text-purple-100 mb-4 sm:mb-6 text-sm sm:text-base">Use our AI-powered generator to create a personalized apology letter</p>
        <a
          href="/generator"
          class="inline-flex items-center space-x-2 bg-white text-purple-600 px-6 py-3 rounded-xl font-semibold hover:bg-gray-100 transition-colors duration-300 font-sans"
        >
          <span>Generate Letter</span>
          <svg class="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 7l5 5m0 0l-5 5m5-5H6" />
          </svg>
        </a>
      </div>
    </div>
  </main>
</Layout>
