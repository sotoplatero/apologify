---
import Layout from '../../../layouts/Layout.astro';
import { getCollection } from 'astro:content';
import type { CollectionEntry } from 'astro:content';
import { recipients } from '../../../lib/apologyData';
import Letter from '@/components/Letter.svelte';
import CallToAction from '@/components/CallToAction.astro';
import { getLetterBySlug } from '../../../lib/letters';

export const prerender = false; // Changed to false to support generated letters

const { recipient, slug } = Astro.params;

if (!recipient || !slug) {
  return Astro.redirect('/examples');
}

// Try to get the letter (static or generated)
const letter = await getLetterBySlug(recipient, slug);

// Handle case where letter is not found
if (!letter) {
  return Astro.redirect('/404');
}

const recipientLabel = recipients.find(r => r.value === recipient)?.label || recipient;

// Generate meta description
const metaDescription = `Example ${letter.tone} apology letter to ${recipientLabel}. ${letter.context}. ${letter.letters[0].slice(0, 100)}...`;

// Canonical URL
const canonicalUrl = new URL(Astro.url.pathname, Astro.site).href;

// Breadcrumb schema
const breadcrumbSchema = {
  "@context": "https://schema.org",
  "@type": "BreadcrumbList",
  "itemListElement": [
    {
      "@type": "ListItem",
      "position": 1,
      "name": "Home",
      "item": "https://apologify.com"
    },
    {
      "@type": "ListItem",
      "position": 2,
      "name": "Examples",
      "item": "https://apologify.com/examples"
    },
    {
      "@type": "ListItem",
      "position": 3,
      "name": recipientLabel,
      "item": `https://apologify.com/examples/${recipient}`
    },
    {
      "@type": "ListItem",
      "position": 4,
      "name": letter.context
    }
  ]
};

// Letter schema (Article/CreativeWork)
const letterSchema = {
  "@context": "https://schema.org",
  "@type": "CreativeWork",
  "headline": `Apology to ${recipientLabel}: ${letter.context}`,
  "description": metaDescription,
  "genre": letter.tone,
  "keywords": [recipient, letter.context, letter.tone, "apology letter", "apology example"],
  "author": {
    "@type": "Organization",
    "name": "Apologify"
  },
  "publisher": {
    "@type": "Organization",
    "name": "Apologify",
    "url": "https://apologify.com"
  },
  "dateCreated": letter.source === 'generated' && letter.created_at
    ? new Date(letter.created_at).toISOString()
    : new Date().toISOString(),
  "isPartOf": {
    "@type": "CreativeWorkSeries",
    "name": `Apology Letters to ${recipientLabel}`,
    "url": `https://apologify.com/examples/${recipient}`
  }
};
---

<Layout
  title={`Apology to ${recipientLabel}: ${letter.context}`}
  description={metaDescription}
  canonicalUrl={canonicalUrl}
  schema={[breadcrumbSchema, letterSchema]}
>
  <main class="max-w-screen-md mx-auto px-4  py-8">
    <h1 class="text-4xl font-bold mb-4 text-center">Apology Letters to {recipientLabel}. <br /> {letter.context}</h1>

    {letter.source === 'generated' && (
      <div class="text-center mb-4">
        <span class="inline-flex items-center px-3 py-1 rounded-lg text-sm font-medium bg-green-100 text-green-800">
          âœ¨ AI Generated Letter
        </span>
      </div>
    )}

    <div class="flex flex-col gap-8">
      {letter.letters.map((letterText: string, index: number) => (
        <Letter letter={letterText} client:load />
      ))}
    </div>

    <div class="my-16 flex justify-center">
      <a href={`/examples/${recipient}`} class="btn btn-outline capitalize">
        {recipientLabel} Letters
      </a>
    </div>

    <CallToAction />

  </main>
</Layout>
