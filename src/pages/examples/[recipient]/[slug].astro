---
import Layout from "../../../layouts/Layout.astro";
import { getCollection } from "astro:content";
import { recipients } from "../../../lib/apologyData";
import Letter from "@/components/Letter.svelte";
import CallToAction from "@/components/CallToAction.astro";
import Breadcrumb from "@/components/Breadcrumb.astro";
import { getLetterBySlug } from "../../../lib/letters";
import { getRelatedLetters } from "../../../lib/db";

export const prerender = false; // Changed to false to support generated letters

const { recipient, slug } = Astro.params;

// Get related articles for internal linking
const allArticles = await getCollection("articles");

// Find articles related to this recipient/context
const getRelatedArticles = (
  currentRecipient: string,
  currentContext: string,
  limit: number = 3,
) => {
  const recipientLower = currentRecipient.toLowerCase();
  const contextLower = currentContext.toLowerCase();

  return allArticles
    .filter((article) => {
      const slug = article.slug.toLowerCase();
      const title = article.data.title.toLowerCase();
      const description = article.data.description?.toLowerCase() || "";

      // Match by recipient in slug or content
      if (slug.includes(recipientLower) || title.includes(recipientLower)) {
        return true;
      }

      // Match by context keywords
      const contextKeywords = [
        "money",
        "borrow",
        "support",
        "emotional",
        "anniversary",
        "forgot",
        "prioritize",
        "work",
        "respect",
        "boundaries",
        "trust",
        "mistake",
      ];
      for (const keyword of contextKeywords) {
        if (
          contextLower.includes(keyword) &&
          (slug.includes(keyword) || description.includes(keyword))
        ) {
          return true;
        }
      }

      return false;
    })
    .slice(0, limit);
};

if (!recipient || !slug) {
  return Astro.redirect("/examples");
}

// Try to get the letter (static or generated)
const letter = await getLetterBySlug(recipient, slug);

// Handle case where letter is not found
if (!letter) {
  return Astro.redirect("/404");
}

const recipientLabel =
  recipients.find((r) => r.value === recipient)?.label || recipient;
const displayTitle = letter.title;

// Get related letters from the same recipient
const relatedLetters = await getRelatedLetters(recipient, slug, 4);

// Generate optimized meta description (150-160 characters)
const getContextDescription = (context: string) => {
  const contextLower = context.toLowerCase();
  if (contextLower.includes("money") || contextLower.includes("borrowed")) {
    return `Need to apologize for borrowing money? Here's a sincere ${letter.tone} apology letter to ${recipientLabel} for ${context.toLowerCase()}. Use this template to make things right.`;
  }
  if (contextLower.includes("support") || contextLower.includes("emotional")) {
    return `Failed to be there when needed? This ${letter.tone} apology letter to ${recipientLabel} addresses ${context.toLowerCase()}. Express sincere regret and rebuild trust.`;
  }
  if (contextLower.includes("anniversary") || contextLower.includes("forgot")) {
    return `Forgot an important date? This heartfelt ${letter.tone} apology letter to ${recipientLabel} for ${context.toLowerCase()} will help you express sincere regret.`;
  }
  if (contextLower.includes("prioritize") || contextLower.includes("work")) {
    return `Work came first? This ${letter.tone} apology letter to ${recipientLabel} for ${context.toLowerCase()} acknowledges the hurt and offers reassurance.`;
  }
  if (contextLower.includes("respect") || contextLower.includes("boundaries")) {
    return `Crossed a line? This sincere ${letter.tone} apology letter to ${recipientLabel} for ${context.toLowerCase()} shows accountability and commitment to change.`;
  }
  // Default optimized description
  return `Looking for a ${letter.tone} apology letter to ${recipientLabel} for ${context.toLowerCase()}? This example shows how to express sincere regret effectively.`;
};

const metaDescription = getContextDescription(letter.context);

// Breadcrumb items for visual navigation
const breadcrumbItems: { name: string; href: string | undefined }[] = [
  { name: "Home", href: "/" },
  { name: "Examples", href: "/examples" },
  { name: recipientLabel, href: `/examples/${recipient}` },
  { name: displayTitle || letter.context, href: undefined },
];

// Canonical URL
const canonicalUrl = new URL(Astro.url.pathname, Astro.site).href;

// Breadcrumb schema
const breadcrumbSchema = {
  "@context": "https://schema.org",
  "@type": "BreadcrumbList",
  itemListElement: [
    {
      "@type": "ListItem",
      position: 1,
      name: "Home",
      item: "https://apologify.com",
    },
    {
      "@type": "ListItem",
      position: 2,
      name: "Examples",
      item: "https://apologify.com/examples",
    },
    {
      "@type": "ListItem",
      position: 3,
      name: recipientLabel,
      item: `https://apologify.com/examples/${recipient}`,
    },
    {
      "@type": "ListItem",
      position: 4,
      name: displayTitle,
    },
  ],
};

// Letter schema (Article/CreativeWork)
const letterSchema = {
  "@context": "https://schema.org",
  "@type": "CreativeWork",
  headline: `Apology to ${recipientLabel}: ${displayTitle}`,
  description: metaDescription,
  genre: letter.tone,
  keywords: [
    recipient,
    letter.context,
    letter.tone,
    "apology letter",
    "apology example",
  ],
  author: {
    "@type": "Organization",
    name: "Apologify",
  },
  publisher: {
    "@type": "Organization",
    name: "Apologify",
    url: "https://apologify.com",
  },
  dateCreated:
    letter.source === "generated" && letter.created_at
      ? new Date(letter.created_at).toISOString()
      : new Date().toISOString(),
  isPartOf: {
    "@type": "CreativeWorkSeries",
    name: `Apology Letters to ${recipientLabel}`,
    url: `https://apologify.com/examples/${recipient}`,
  },
};
---

<Layout
  title={`Apology to ${recipientLabel}: ${displayTitle}`}
  description={metaDescription}
  canonicalUrl={canonicalUrl}
  schema={[breadcrumbSchema, letterSchema]}
>
  <Breadcrumb items={breadcrumbItems} />

  <main class="max-w-screen-md mx-auto px-4 py-8">
    <h1 class="text-4xl font-bold mb-4 text-center">
      Apology Letters to {recipientLabel}. <br />
      {displayTitle}
    </h1>

    {
      letter.source === "generated" && (
        <div class="text-center mb-4">
          <span class="inline-flex items-center px-3 py-1 rounded-lg text-sm font-medium bg-green-100 text-green-800">
            âœ¨ AI Generated Letter
          </span>
        </div>
      )
    }

    <div class="flex flex-col gap-8">
      {
        letter.letters.map((letterText: string, index: number) => (
          <Letter letter={letterText} context={letter.context} client:load />
        ))
      }
    </div>

    {/* More Letters Like This - Same Recipient */}
    {
      relatedLetters.length > 0 && (
        <section class="my-12">
          <div class="flex items-center gap-3 mb-6">
            <svg
              class="w-6 h-6 text-purple-600"
              fill="none"
              viewBox="0 0 24 24"
              stroke="currentColor"
            >
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="2"
                d="M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2M5 11V9a2 2 0 012-2m0 0V5a2 2 0 012-2h6a2 2 0 012 2v2M7 7h10"
              />
            </svg>
            <h2 class="text-2xl font-bold text-gray-800">
              More {recipientLabel} Apology Letters
            </h2>
          </div>
          <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            {relatedLetters.map((relatedLetter) => (
              <a
                href={`/examples/${recipient}/${relatedLetter.slug}`}
                class="group block bg-white hover:bg-purple-50 rounded-lg p-5 border-2 border-gray-200 hover:border-purple-400 transition-all duration-200 shadow-sm hover:shadow-md"
              >
                <div class="flex items-start justify-between gap-3">
                  <div class="flex-1">
                    <h3 class="font-semibold text-gray-800 group-hover:text-purple-700 mb-1 line-clamp-1">
                      {relatedLetter.title || relatedLetter.context}
                    </h3>
                    <div class="flex items-center gap-2 text-sm text-gray-500">
                      <span class="inline-block px-2 py-1 bg-gray-100 rounded text-xs">
                        {relatedLetter.tone}
                      </span>
                      <span class="line-clamp-1">
                        {relatedLetter.letters[0].slice(0, 60)}...
                      </span>
                    </div>
                  </div>
                  <svg
                    class="w-5 h-5 text-purple-600 flex-shrink-0 group-hover:translate-x-1 transition-transform duration-200"
                    fill="none"
                    viewBox="0 0 24 24"
                    stroke="currentColor"
                  >
                    <path
                      stroke-linecap="round"
                      stroke-linejoin="round"
                      stroke-width="2"
                      d="M9 5l7 7-7 7"
                    />
                  </svg>
                </div>
              </a>
            ))}
          </div>
        </section>
      )
    }

    <div class="my-16 flex justify-center">
      <a
        href={`/examples/${recipient}`}
        class="inline-flex items-center gap-2 px-8 py-4 bg-purple-600 text-white rounded-xl hover:bg-purple-700 transition-all duration-300 font-medium shadow-lg hover:shadow-xl hover:scale-105"
      >
        <svg
          class="w-5 h-5"
          fill="none"
          viewBox="0 0 24 24"
          stroke="currentColor"
        >
          <path
            stroke-linecap="round"
            stroke-linejoin="round"
            stroke-width="2"
            d="M15 19l-7-7 7-7"></path>
        </svg>
        <span>View All {recipientLabel} Letters</span>
      </a>
    </div>

    {/* Related Articles Section - Internal Linking */}
    {
      getRelatedArticles(recipient, letter.context).length > 0 && (
        <section class="my-16 py-12 bg-gradient-to-br from-purple-50 to-blue-50 rounded-2xl px-6 shadow-lg">
          <div class="flex items-center gap-3 mb-8">
            <svg
              class="w-8 h-8 text-purple-600"
              fill="none"
              viewBox="0 0 24 24"
              stroke="currentColor"
            >
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="2"
                d="M12 6.253v13m0-13C10.832 5.477 9.246 5 7.5 5S4.168 5.477 3 6.253v13C4.168 18.477 5.754 18 7.5 18s3.332.477 4.5 1.253m0-13C13.168 5.477 14.754 5 16.5 5c1.747 0 3.332.477 4.5 1.253v13C19.832 18.477 18.247 18 16.5 18c-1.746 0-3.332.477-4.5 1.253"
              />
            </svg>
            <h2 class="text-3xl font-bold text-gray-800">
              Related Articles & Tips
            </h2>
          </div>
          <p class="text-gray-600 mb-8 text-lg">
            Learn more about writing effective apologies with these helpful
            guides:
          </p>
          <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
            {getRelatedArticles(recipient, letter.context).map((article) => (
              <a
                href={`/articles/${article.slug}`}
                class="group block bg-white hover:bg-purple-50 rounded-xl p-6 transition-all duration-300 border-2 border-gray-200 hover:border-purple-400 shadow-md hover:shadow-xl transform hover:-translate-y-1"
              >
                <div class="flex items-start gap-3">
                  <div class="flex-shrink-0 w-10 h-10 bg-purple-100 rounded-lg flex items-center justify-center group-hover:bg-purple-200 transition-colors">
                    <svg
                      class="w-6 h-6 text-purple-600"
                      fill="none"
                      viewBox="0 0 24 24"
                      stroke="currentColor"
                    >
                      <path
                        stroke-linecap="round"
                        stroke-linejoin="round"
                        stroke-width="2"
                        d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"
                      />
                    </svg>
                  </div>
                  <div class="flex-1">
                    <h3 class="font-bold text-gray-800 group-hover:text-purple-700 mb-2 line-clamp-2 text-lg leading-tight">
                      {article.data.title}
                    </h3>
                    <p class="text-sm text-gray-600 line-clamp-3 leading-relaxed">
                      {article.data.description}
                    </p>
                  </div>
                </div>
                <div class="mt-4 flex items-center text-purple-600 font-medium text-sm group-hover:translate-x-1 transition-transform duration-200">
                  <span>Read more</span>
                  <svg
                    class="w-4 h-4 ml-1"
                    fill="none"
                    viewBox="0 0 24 24"
                    stroke="currentColor"
                  >
                    <path
                      stroke-linecap="round"
                      stroke-linejoin="round"
                      stroke-width="2"
                      d="M9 5l7 7-7 7"
                    />
                  </svg>
                </div>
              </a>
            ))}
          </div>
        </section>
      )
    }

    <CallToAction />
  </main>
</Layout>
