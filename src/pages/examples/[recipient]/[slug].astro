---
import Layout from '../../../layouts/Layout.astro';
import { getCollection } from 'astro:content';
import type { CollectionEntry } from 'astro:content';
import { recipients } from '../../../lib/apologyData';
import Letter from '@/components/Letter.svelte';
import CallToAction from '@/components/CallToAction.astro';
import { getLetterBySlug } from '../../../lib/letters';

export const prerender = false; // Changed to false to support generated letters

const { recipient, slug } = Astro.params;

if (!recipient || !slug) {
  return Astro.redirect('/examples');
}

// Try to get the letter (static or generated)
const letter = await getLetterBySlug(recipient, slug);

// Handle case where letter is not found
if (!letter) {
  return Astro.redirect('/404');
}

const recipientLabel = recipients.find(r => r.value === recipient)?.label || recipient;
---

<Layout title={`Apology Letters to ${recipientLabel}`} description={`Example apology letters to ${recipientLabel}. ${letter.context}`}>
  <main class="max-w-screen-md mx-auto px-4  py-8">
    <h1 class="text-4xl font-bold mb-4 text-center">Apology Letters to {recipientLabel}. <br /> {letter.context}</h1>

    {letter.source === 'generated' && (
      <div class="text-center mb-4">
        <span class="inline-flex items-center px-3 py-1 rounded-lg text-sm font-medium bg-green-100 text-green-800">
          âœ¨ AI Generated Letter
        </span>
      </div>
    )}

    <div class="flex flex-col gap-8">
      {letter.letters.map((letterText: string, index: number) => (
        <Letter letter={letterText} client:load />
      ))}
    </div>

    <div class="my-16 flex justify-center">
      <a href={`/examples/${recipient}`} class="btn btn-outline capitalize">
        {recipientLabel} Letters
      </a>
    </div>

    <CallToAction />

  </main>
</Layout>
