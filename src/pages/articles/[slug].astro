---
import { getCollection } from 'astro:content';
import type { CollectionEntry } from 'astro:content';
import Layout from '@/layouts/Layout.astro';
import UnsplashImage from '@/components/UnsplashImage.astro';
import CallToAction from '@/components/CallToAction.astro';
import CtaMini from '@/components/CtaMini.astro';
import Breadcrumb from '@/components/Breadcrumb.astro';
import { insertRelatedLinksMarkdown } from '@/lib/insertRelatedLinksMarkdown';

export const prerender = true;

export async function getStaticPaths() {
  const articleEntries = await getCollection('articles');
  return articleEntries.map(entry => ({
    params: { slug: entry.slug },
    props: { entry },
  }));
}

const { entry } = Astro.props;

// Add safety check for entry prop
if (!entry) {
  throw new Error('Entry prop is undefined. Check getStaticPaths function.');
}

const { Content } = await entry.render();

const articles = await getCollection('articles');
const sortedArticles = articles.sort((a, b) => 
  new Date(b.data.date || 0).getTime() - new Date(a.data.date || 0).getTime()
);

const currentIndex = sortedArticles.findIndex(article => article.slug === entry.slug);
const prevArticle = sortedArticles[currentIndex + 1];
const nextArticle = sortedArticles[currentIndex - 1];

// Get related articles based on tags and content
const getRelatedArticles = (currentArticle: CollectionEntry<'articles'>, allArticles: CollectionEntry<'articles'>[], limit: number = 4) => {
  const currentTags = currentArticle.data.tags || [];

  return allArticles
    .filter(article => article.slug !== currentArticle.slug)
    .map(article => ({
      article,
      score: (article.data.tags || []).filter((tag: string) => currentTags.includes(tag)).length
    }))
    .sort((a, b) => b.score - a.score)
    .slice(0, limit)
    .map(item => item.article);
};

// Preparar datos para el Schema.org
const schema = {
  "@context": "https://schema.org",
  "@type": "Article",
  "headline": entry.data.title,
  "description": entry.data.description,
  "image": entry.data.image,
  "datePublished": entry.data.date?.toISOString() || new Date().toISOString(),
  "dateModified": entry.data.date?.toISOString() || new Date().toISOString(),
  "author": {
    "@type": "Organization",
    "name": "Apologify"
  },
  "publisher": {
    "@type": "Organization",
    "name": "Apologify",
    "logo": {
      "@type": "ImageObject",
      "url": "https://apologify.com/logo.png"
    }
  },
  "mainEntityOfPage": {
    "@type": "WebPage",
    "@id": `https://apologify.com/articles/${entry.slug}`
  }
};

// Breadcrumb schema
const breadcrumbSchema = {
  "@context": "https://schema.org",
  "@type": "BreadcrumbList",
  "itemListElement": [
    {
      "@type": "ListItem",
      "position": 1,
      "name": "Home",
      "item": "https://apologify.com"
    },
    {
      "@type": "ListItem",
      "position": 2,
      "name": "Articles",
      "item": "https://apologify.com/articles"
    },
    {
      "@type": "ListItem",
      "position": 3,
      "name": entry.data.title
    }
  ]
};

// Canonical URL
const canonicalUrl = new URL(Astro.url.pathname, Astro.site).href;

// Breadcrumb items for visual navigation
const breadcrumbItems = [
  { name: 'Home', href: '/' },
  { name: 'Articles', href: '/articles' },
  { name: entry.data.title, href: undefined }
];
---

<Layout
  title={entry.data.title}
  description={entry.data.description}
  canonicalUrl={canonicalUrl}
  schema={[schema, breadcrumbSchema]}
>
  {/* Reading Progress Indicator */}
  <div id="reading-progress" class="fixed top-0 left-0 w-full h-1 bg-gray-200 z-50">
    <div id="reading-progress-bar" class="h-full bg-gradient-to-r from-purple-600 to-blue-600 transition-all duration-150" style="width: 0%"></div>
  </div>

  <Breadcrumb items={breadcrumbItems} />

<article class="prose prose-xl mx-auto mt-8" id="article-content">
  {entry.data.date && (
    <time datetime={entry.data?.date.toISOString()} class="text-gray-500">
        {entry.data.date.toLocaleDateString()}
      </time>
    )}

<h1>{entry.data.title}</h1>

<UnsplashImage article={entry} />
<CtaMini />

    <Content />
  </article>

  {/* Related Articles Section */}
  {getRelatedArticles(entry, sortedArticles).length > 0 && (
    <section class="max-w-4xl mx-auto mt-16 mb-12 py-12 px-6 bg-gradient-to-br from-purple-50 to-blue-50 rounded-2xl shadow-lg">
      <div class="flex items-center gap-3 mb-8">
        <svg class="w-8 h-8 text-purple-600" fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2M5 11V9a2 2 0 012-2m0 0V5a2 2 0 012-2h6a2 2 0 012 2v2M7 7h10" />
        </svg>
        <h2 class="text-3xl font-bold text-gray-800">Related Articles</h2>
      </div>
      <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
        {getRelatedArticles(entry, sortedArticles).map((article) => (
          <a
            href={`/articles/${article.slug}`}
            class="group block bg-white hover:bg-purple-50 rounded-xl p-6 transition-all duration-300 border-2 border-gray-200 hover:border-purple-400 shadow-md hover:shadow-xl transform hover:-translate-y-1"
          >
            <div class="flex items-start gap-4">
              {article.data.image && (
                <div class="flex-shrink-0 w-20 h-20 rounded-lg overflow-hidden">
                  <img
                    src={article.data.image}
                    alt={article.data.title}
                    class="w-full h-full object-cover group-hover:scale-110 transition-transform duration-300"
                  />
                </div>
              )}
              <div class="flex-1">
                <h3 class="font-bold text-gray-800 group-hover:text-purple-700 mb-2 line-clamp-2 text-lg leading-tight">
                  {article.data.title}
                </h3>
                <p class="text-sm text-gray-600 line-clamp-2 leading-relaxed">
                  {article.data.description}
                </p>
                <div class="mt-3 flex items-center text-purple-600 font-medium text-sm group-hover:translate-x-1 transition-transform duration-200">
                  <span>Read more</span>
                  <svg class="w-4 h-4 ml-1" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" />
                  </svg>
                </div>
              </div>
            </div>
          </a>
        ))}
      </div>
    </section>
  )}

  <!-- Navigation links -->
  <div class="flex justify-between my-8">
    {prevArticle && (
      <a href={`/articles/${prevArticle.slug}`} class="text-blue-500 hover:underline">
        ← {prevArticle.data.title}
      </a>
    )}
    {nextArticle && (
      <a href={`/articles/${nextArticle.slug}`} class="text-blue-500 hover:underline ml-auto">
        {nextArticle.data.title} →
      </a>
    )}
  </div>

  <CallToAction />
</Layout>

<script>
  // Reading progress indicator
  const updateProgress = () => {
    const article = document.getElementById('article-content');
    const progressBar = document.getElementById('reading-progress-bar');

    if (!article || !progressBar) return;

    const articleTop = article.offsetTop;
    const articleHeight = article.offsetHeight;
    const windowTop = window.scrollY;
    const windowHeight = window.innerHeight;

    const progress = Math.min(
      100,
      Math.max(
        0,
        ((windowTop - articleTop + windowHeight) / articleHeight) * 100
      )
    );

    progressBar.style.width = `${progress}%`;
  };

  // Throttle function for performance
  let ticking = false;
  const onScroll = () => {
    if (!ticking) {
      window.requestAnimationFrame(() => {
        updateProgress();
        ticking = false;
      });
      ticking = true;
    }
  };

  // Add event listener
  window.addEventListener('scroll', onScroll, { passive: true });
  window.addEventListener('resize', updateProgress, { passive: true });

  // Initial update
  updateProgress();
</script>

<style is:global>
  pre {
    @apply !bg-gray-100 !text-black !p-8 !rounded-md !border border-gray-200 !text-wrap;
  } 
  blockquote {
    @apply bg-blue-50 border-l-4 border-blue-500 p-4 my-4 italic;
  }
</style>
