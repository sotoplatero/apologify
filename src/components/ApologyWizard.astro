---
import { actions } from 'astro:actions';



const tones = [
  { value: 'formal', label: 'Formal' },
  { value: 'casual', label: 'Casual' },
  { value: 'heartfelt', label: 'Heartfelt' },
  { value: 'professional', label: 'Professional' },
  { value: 'sincere', label: 'Sincere' },
  { value: 'remorseful', label: 'Remorseful' }
];

const recipients = [
  { value: 'mother', label: 'Mother' },
  { value: 'father', label: 'Father' },
  { value: 'spouse', label: 'Spouse' },
  { value: 'friend', label: 'Friend' },
  { value: 'colleague', label: 'Colleague' },
  { value: 'romantic', label: 'Romantic partner' },
  { value: 'boss', label: 'Boss' },
  { value: 'client', label: 'Client' },
  { value: 'teacher', label: 'Teacher' },
];

const defaultTone = tones[0].value;
const defaultRecipient = recipients[0].value;


---

<div class="card w-full max-w-2xl bg-base-100 shadow-xl mx-auto">
  <div class="card-body">
    <form action={actions.createLetter} method="POST" id="apologyWizard" class="space-y-4">
      <div class="step-container min-h-[200px]">
        <div class="step" data-step="1">
          <h2 class="card-title mb-4">Relationship with the recipient</h2>
          <select transition:persist name="relationship" class="select select-bordered w-full" required>
            {recipients.map((r) => (
              <option value={r.value} selected={r.value === defaultRecipient}>{r.label}</option>
            ))}
          </select>
        </div>

        <div class="step hidden" data-step="2">
          <h2 class="card-title mb-4">Context or situation</h2>
          <textarea transition:persist name="context" rows="4" class="textarea textarea-bordered w-full" required placeholder="Provide some context about the situation..."></textarea>
        </div>

        <div class="step hidden" data-step="3">
          <h2 class="card-title mb-4">Desired tone</h2>
          <div class="grid grid-cols-2 md:grid-cols-3 gap-4">
            {tones.map((tone) => (
              <button type="button" class={`tone-btn btn btn-outline ${tone.value === defaultTone ? 'btn-active' : ''}`} data-value={tone.value}>
                {tone.label}
              </button>
            ))}
          </div>
          <input transition:persist type="hidden" name="tone" value={defaultTone} required>
        </div>
      </div>

      <div class="card-actions justify-end mt-6">
        <button type="button" id="prevBtn" class="btn btn-ghost">Previous</button>
        <button type="button" id="nextBtn" class="btn btn-primary">Next</button>
      </div>
    </form>
  </div>
</div>

<script define:vars={{ defaultTone, defaultRecipient }}>
  let currentStep = 1;
  const totalSteps = 3;

  const form = document.getElementById('apologyWizard');
  const prevBtn = document.getElementById('prevBtn');
  const nextBtn = document.getElementById('nextBtn');

  function showStep(step) {
    document.querySelectorAll('.step').forEach(el => el.classList.add('hidden'));
    document.querySelector(`.step[data-step="${step}"]`)?.classList.remove('hidden');
    
    prevBtn.style.display = step === 1 ? 'none' : 'inline-flex';
    nextBtn.textContent = step === totalSteps ? 'Submit' : 'Next';
  }

  function validateStep(step) {
    const currentStepElement = document.querySelector(`.step[data-step="${step}"]`);
    const inputs = currentStepElement?.querySelectorAll('input:not([type="hidden"]), select, textarea');
    return Array.from(inputs || []).every((input) => input.checkValidity());
  }

  prevBtn.addEventListener('click', () => {
    if (currentStep > 1) {
      currentStep--;
      showStep(currentStep);
    }
  });

  nextBtn.addEventListener('click', () => {
    if (validateStep(currentStep)) {
      if (currentStep < totalSteps) {
        currentStep++;
        showStep(currentStep);
      } else {
        // Handle form submission
        form.submit();
      }
    } else {
      alert('Please fill out all required fields before proceeding.');
    }
  });

  // Tone button functionality
  const toneButtons = document.querySelectorAll('.tone-btn');
  const toneInput = document.querySelector('input[name="tone"]');

  toneButtons.forEach(button => {
    button.addEventListener('click', () => {
      toneButtons.forEach(btn => btn.classList.remove('btn-active'));
      button.classList.add('btn-active');
      toneInput.value = button.getAttribute('data-value') || '';
    });
  });

  // Initialize with the first step, default tone and default recipient
  showStep(currentStep);
  toneInput.value = defaultTone;
  document.querySelector('select[name="relationship"]').value = defaultRecipient;
</script>
